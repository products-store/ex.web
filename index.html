<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام تصوير التمارين الاحترافي</title>
    <style>
        :root { --primary: #2563eb; --success: #10b981; --bg: #f8fafc; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 15px; margin: 0; direction: rtl; }
        .setup-section { background: #fee2e2; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; border: 1px solid #ef4444; }
        .exercise-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .status-dots { display: flex; gap: 10px; margin-top: 15px; align-items: center; }
        .dot { width: 30px; height: 30px; border-radius: 50%; border: 2px solid #ddd; display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; }
        .dot.active { background: var(--success); color: white; border-color: var(--success); }
        .dot.active::after { content: "✓"; }
        .btn-capture { background: var(--primary); color: white; padding: 12px; border: none; border-radius: 8px; width: 100%; font-weight: bold; margin-top: 10px; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="setup-section" id="setup-box">
        <p>يجب اختيار مجلد الحفظ الرئيسي على جهازك لبدء العمل</p>
        <button onclick="initFileSystem()" style="padding: 10px; background: #ef4444; color: white; border: none; border-radius: 5px;">اختيار مجلد الحفظ</button>
    </div>

    <div id="exercise-list"></div>

    <input type="file" id="camera-input" accept="image/*,video/*" capture="environment" class="hidden">

    <script>
        const exercises = [
            { id: 1, name: "Brisk Walking", type: "LISS" },
            { id: 2, name: "Assisted Nordic Curl", type: "Compound" },
            { id: 3, name: "Assisted Shrimp Squat", type: "Compound" },
            { id: 4, name: "Assisted Single-Arm Row", type: "Compound" },
            { id: 5, name: "Bench Dip (Straight)", type: "Isolation" }
        ];

        let rootHandle = null;
        let progress = JSON.parse(localStorage.getItem('workout_progress')) || {};

        async function initFileSystem() {
            try {
                // طلب إذن الوصول لمجلد من قبل المستخدم
                rootHandle = await window.showDirectoryPicker();
                document.getElementById('setup-box').classList.add('hidden');
                render();
            } catch (err) {
                alert("يجب اختيار مجلد لنتمكن من حفظ الملفات.");
            }
        }

        function render() {
            const container = document.getElementById('exercise-list');
            container.innerHTML = exercises.map(ex => {
                const state = progress[ex.id] || { count: 0 };
                return `
                <div class="exercise-card">
                    <h3>${ex.name}</h3>
                    <button class="btn-capture" onclick="openCamera(${ex.id})">تصوير (صورة/فيديو)</button>
                    <div class="status-dots">
                        <span>التقدم (5 مهام):</span>
                        ${[1,2,3,4,5].map(i => `
                            <div class="dot ${state.count >= i ? 'active' : ''}" 
                                 onclick="deleteTask(${ex.id}, ${i})">
                                 ${state.count >= i ? '' : i}
                            </div>
                        `).join('')}
                    </div>
                </div>
                `;
            }).join('');
        }

        let activeExId = null;
        function openCamera(id) {
            if (!rootHandle) return alert("يرجى اختيار مجلد الحفظ أولاً");
            activeExId = id;
            document.getElementById('camera-input').click();
        }

        document.getElementById('camera-input').onchange = async (e) => {
            const file = e.target.files[0];
            if (!file || !activeExId) return;

            const ex = exercises.find(item => item.id === activeExId);
            if (!progress[activeExId]) progress[activeExId] = { count: 0 };
            
            if (progress[activeExId].count >= 5) {
                alert("اكتملت جميع المهام لهذا التمرين");
                return;
            }

            try {
                progress[activeExId].count++;
                const fileIndex = progress[activeExId].count;
                const extension = file.type.startsWith('video') ? 'mp4' : 'jpg';
                const fileName = `${ex.name}.${fileIndex}.${extension}`;

                // 1. إنشاء/الوصول لمجلد التمرين
                const exFolderHandle = await rootHandle.getDirectoryHandle(ex.name, { create: true });
                
                // 2. إنشاء الملف وحفظه
                const fileHandle = await exFolderHandle.getFileHandle(fileName, { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(file);
                await writable.close();

                localStorage.setItem('workout_progress', JSON.stringify(progress));
                render();
                alert(`تم الحفظ بنجاح: ${fileName}`);
            } catch (err) {
                console.error(err);
                alert("خطأ أثناء الحفظ. تأكد من إعطاء الصلاحيات.");
            }
        };

        function deleteTask(id, index) {
            if (progress[id] && progress[id].count >= index) {
                if (confirm("هل تريد حذف هذا السجل من القائمة؟ (لن يُحذف الملف من الجهاز)")) {
                    progress[id].count = index - 1;
                    localStorage.setItem('workout_progress', JSON.stringify(progress));
                    render();
                }
            }
        }

        if (rootHandle) document.getElementById('setup-box').classList.add('hidden');
        render();
    </script>
</body>
</html>
